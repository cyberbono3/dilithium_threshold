use super::poly::{N, Q};

// Roots of unity in order needed by forward ntt
const ZETAS: [i64; N] = [
    0, 25847, -2608894, -518909, 237124, -777960, -876248, 466468, 1826347,
    2353451, -359251, -2091905, 3119733, -2884855, 3111497, 2680103, 2725464,
    1024112, -1079900, 3585928, -549488, -1119584, 2619752, -2108549, -2118186,
    -3859737, -1399561, -3277672, 1757237, -19422, 4010497, 280005, 2706023,
    95776, 3077325, 3530437, -1661693, -3592148, -2537516, 3915439, -3861115,
    -3043716, 3574422, -2867647, 3539968, -300467, 2348700, -539299, -1699267,
    -1643818, 3505694, -3821735, 3507263, -2140649, -1600420, 3699596, 811944,
    531354, 954230, 3881043, 3900724, -2556880, 2071892, -2797779, -3930395,
    -1528703, -3677745, -3041255, -1452451, 3475950, 2176455, -1585221,
    -1257611, 1939314, -4083598, -1000202, -3190144, -3157330, -3632928,
    126922, 3412210, -983419, 2147896, 2715295, -2967645, -3693493, -411027,
    -2477047, -671102, -1228525, -22981, -1308169, -381987, 1349076, 1852771,
    -1430430, -3343383, 264944, 508951, 3097992, 44288, -1100098, 904516,
    3958618, -3724342, -8578, 1653064, -3249728, 2389356, -210977, 759969,
    -1316856, 189548, -3553272, 3159746, -1851402, -2409325, -177440, 1315589,
    1341330, 1285669, -1584928, -812732, -1439742, -3019102, -3881060,
    -3628969, 3839961, 2091667, 3407706, 2316500, 3817976, -3342478, 2244091,
    -2446433, -3562462, 266997, 2434439, -1235728, 3513181, -3520352, -3759364,
    -1197226, -3193378, 900702, 1859098, 909542, 819034, 495491, -1613174,
    -43260, -522500, -655327, -3122442, 2031748, 3207046, -3556995, -525098,
    -768622, -3595838, 342297, 286988, -2437823, 4108315, 3437287, -3342277,
    1735879, 203044, 2842341, 2691481, -2590150, 1265009, 4055324, 1247620,
    2486353, 1595974, -3767016, 1250494, 2635921, -3548272, -2994039, 1869119,
    1903435, -1050970, -1333058, 1237275, -3318210, -1430225, -451100, 1312455,
    3306115, -1962642, -1279661, 1917081, -2546312, -1374803, 1500165, 777191,
    2235880, 3406031, -542412, -2831860, -1671176, -1846953, -2584293,
    -3724270, 594136, -3776993, -2013608, 2432395, 2454455, -164721, 1957272,
    3369112, 185531, -1207385, -3183426, 162844, 1616392, 3014001, 810149,
    1652634, -3694233, -1799107, -3038916, 3523897, 3866901, 269760, 2213111,
    -975884, 1717735, 472078, -426683, 1723600, -1803090, 1910376, -1667432,
    -1104333, -260646, -3833893, -2939036, -2235985, -420899, -2286327, 183443,
    -976891, 1612842, -3545687, -554416, 3919660, -48306, -1362209, 3937738,
    1400424, -846154, 1976782,
];

// 32 bit  airthmetic
const QINV: i32 = 58728449;

pub fn montgomery_reduce(a: i64) -> i32 {
    let mut t = (a as i32).wrapping_mul(QINV) as i64;
    t = (a - t * Q as i64) >> 32;
    t as i32
}

/// Forward NTT, in-place.
pub fn ntt(a: &mut [i32]) {
    let mut t;
    let mut k = 0usize;
    let mut len = 128;

    while len > 0 {
        let mut start = 0;
        while start < N {
            k += 1;
            let zeta = ZETAS[k];
            let end = start + len;
            for j in start..end {
                t = montgomery_reduce(zeta * a[j + len] as i64);
                a[j + len] = a[j] - t;
                a[j] += t;
            }
            start += 2 * len;
        }
        len >>= 1;
    }
}

/// Inverse NTT in-place
/// Perform INTT on slices of i32 elements
pub fn intt(a: &mut [i32]) {
    let mut j;
    let mut k = 256usize;
    let mut len = 1;
    let (mut t, mut zeta);
    const F: i64 = 41978; // mont^2/256

    while len < N {
        let mut start = 0;
        while start < 256 {
            k -= 1;
            zeta = -ZETAS[k] as i64;
            j = start;
            while j < (start + len) {
                t = a[j];
                a[j] = t + a[j + len];
                a[j + len] = t - a[j + len];
                a[j + len] = montgomery_reduce(zeta * a[j + len] as i64);
                j += 1
            }
            start = j + len;
        }
        len <<= 1;
    }

    for j in 0..N {
        a[j] = montgomery_reduce(F * a[j] as i64);
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_montgomery_reduce() {
        // Test Montgomery reduction properties
        let a = 12345i64;
        let b = 67890i64;

        // Test that montgomery_reduce is deterministic
        let r1 = montgomery_reduce(a);
        let r2 = montgomery_reduce(a);
        assert_eq!(r1, r2, "Montgomery reduce should be deterministic");

        // Test bounds: result should be in [-Q, Q]
        for i in 0..100 {
            let x = (i * 12345) as i64;
            let r = montgomery_reduce(x);
            assert!(r.abs() <= Q, "Montgomery reduce out of bounds: {}", r);
        }
    }

    #[test]
    fn test_ntt() {
        let mut input = [
            2, -1, 3, 0, -2, 1, -3, 2, 4, -4, 1, -1, 0, 2, -2, 3, -3, 4, -4, 3,
            -1, 2, -2, 1, 0, -3, 3, -4, 4, -1, 1, -2, 2, 0, -1, 3, -3, 4, -4,
            2, -2, 1, -1, 0, 3, -3, 4, -4, 1, -1, 2, -2, 3, -3, 0, 4, -4, 1,
            -1, 2, -2, 3, -3, 0, 4, -4, 3, -3, 2, -2, 1, -1, 0, 4, -4, 3, -3,
            2, -2, 1, -1, 0, 2, -2, 4, -4, 1, -1, 3, -3, 0, 2, -2, 4, -4, 1,
            -1, 3, -3, 0, 1, -1, 2, -2, 3, -3, 4, -4, 0, 1, -1, 2, -2, 3, -3,
            4, -4, 0, 3, -3, 1, -1, 4, -4, 2, -2, 0, 3, -3, 1, -1, 4, -4, 2,
            -2, 0, 4, -4, 3, -3, 2, -2, 1, -1, 0, 4, -4, 3, -3, 2, -2, 1, -1,
            0, 2, -2, 4, -4, 1, -1, 3, -3, 0, 2, -2, 4, -4, 1, -1, 3, -3, 0, 1,
            -1, 2, -2, 3, -3, 4, -4, 0, 1, -1, 2, -2, 3, -3, 4, -4, 0, 3, -3,
            1, -1, 4, -4, 2, -2, 0, 3, -3, 1, -1, 4, -4, 2, -2, 0, 2, -2, 3,
            -3, 1, -1, 4, -4, 0, 2, -2, 3, -3, 1, -1, 4, -4, 0, 4, -4, 2, -2,
            3, -3, 1, -1, 0, 4, -4, 2, -2, 3, -3, 1, -1, 0, 1, -1, 4, -4, 3,
            -3, 2, -2, 0, 1, -1, 4,
        ];

        let output = [
            10782399, 6972977, 4171496, -788460, 245414, 6713026, 3819187,
            -2009247, -1447026, 4893050, 5359721, 1367415, 8500740, 5150544,
            1581543, 2230997, -4189791, 3331945, 1561680, 7716474, 8504412,
            14945592, 8190563, 1616045, 6850260, 8340148, 5497338, 11592894,
            8754679, 16489863, 9667701, 3077397, -1670945, 6182415, -7180628,
            972754, -11192480, -4296566, 3635811, -3824281, 7811213, 4837167,
            984835, 7315337, -943211, 6747199, 13211590, 8541550, 12656228,
            4277618, -807016, 2361810, 10670478, 10621114, 12597299, 7399533,
            2233805, 2393855, 5430558, 1424778, -2431566, 2516744, 1220719,
            8370411, 1486869, 2097715, 3141133, -1240277, 4357728, 2599392,
            3619928, 10646416, 1168240, -1349082, -6334424, -10105942,
            -1985028, 220390, 2603083, -4907805, -13385757, -11485023,
            -2477935, -7791613, -15350625, -12708753, -9448554, -7747924,
            -12342086, -8795108, -6209159, -4310911, 5698648, 3121236,
            -6124529, -1280243, 14097194, 13806412, 11882022, 4264268, 1562232,
            3257490, 5161257, 1709845, 5446318, 115312, 8210026, 3867384,
            1893028, 624828, 4329674, 7169958, 7055343, 282995, -1008227,
            -5008895, 8672580, 2008946, 3658001, -4649591, 2732878, 241994,
            10586093, 9000707, 336593, 1361657, -1262132, 695218, -1652489,
            -5250497, 3950415, 2759131, 6724161, -1028457, -3819301, 537893,
            5455438, -167374, 12641755, 8855073, 8377560, 3934266, 4373134,
            4145244, 2861257, -2331617, -2035715, 5297619, 519102, 3071028,
            124476, -928814, 8653065, 1299895, 3844515, 1325989, 5004967,
            6363211, 3965985, 8505149, 5336845, -2753639, 1242505, 6080833,
            1381546, -3214070, 8775783, 1519813, -851329, -5545001, -5974240,
            -12469606, -5917972, -4116264, 4241284, -777544, 1278616, -4766750,
            -10852796, -7818354, 2392382, -1414692, -6299014, -5982184,
            -954627, -8979509, -5800852, -12163392, -6972394, -11179220,
            -14056930, -7032492, 2913516, -3118586, -1761325, -5464209,
            -8791231, -6092535, -15074210, -7168724, -7923673, -12706605,
            -14971196, -16432506, -6422579, -9493767, -4492908, -6312198,
            -7554101, -6218059, -4500687, -9556377, -2866033, -4180179,
            -553788, 1722176, -4018023, -3540815, -1644296, 4515394, 4681814,
            2427250, 2513703, 6892213, 4067262, 3836100, -2062179, 1048841,
            -3904268, -4056658, -3852752, -10289210, -1841853, -9247821,
            3300849, -1479587, -14408199, -7443127, -7127467, -8977979, 709302,
            4763008, 2259536, 2346442, -2481427, -1592081, -6287336, -3619740,
            -8014179, -4274469, -5456090, -6146374, -6662096, -8104178,
            -17432462, -13150064,
        ];

        super::ntt(&mut input);
        assert_eq!(input, output);
    }

    #[test]
    fn test_intt() {
        let mut a = [
            -410121, -3439227, -1510274, 1543151, -2293562, -1024787, -1768713,
            3416108, -1829266, -39421, 1553720, 383193, -1303564, 2601404,
            178534, 3075833, -1669488, 2938151, 419856, 3374895, -3659025,
            2791925, -2014544, -4116040, 528058, -460960, -498884, -3726436,
            1576721, 1111713, -2404662, 289307, 3590938, 362196, -2812407,
            -1463477, 1001050, 2798150, -472041, 1298972, -601719, -3341683,
            -2239048, -3200450, -1250550, -2932037, -158803, -42310, 1710565,
            1768181, 3343337, -4124626, -970397, 2715826, 650012, -2014903,
            4155312, -570039, -1014542, -1136867, -2854295, 3545986, 3534334,
            1775063, 543277, 1440396, -2274992, -1666074, -2522410, 1374130,
            2546411, 2357995, 3246445, -1637839, -3940900, -22882, 3617374,
            3695910, 3135497, 3461903, 321845, 1837065, -4102518, 2025912,
            4037956, 3262194, -1077158, -104681, 1543795, 2067328, -3128599,
            3610959, 1154470, -1950084, 3161277, -1484341, 3056494, 145395,
            -2412862, 3811285, -2651526, 794539, -1077785, -3775793, 1851954,
            925186, -1420046, -2129292, -2572721, -1709299, 2466220, -1148025,
            -631434, 1616317, 1979838, 1787596, -2046122, 4145612, 2425669,
            -1207333, -3920849, 2920839, -1437055, 2250361, -2512504, -2660187,
            -2934830, 3926550, 1895481, -763893, 1348485, 3392907, -2603573,
            748841, 3508436, -3904020, 800986, 1434045, 3024446, -2067148,
            4058529, -1797892, 2428719, -1661266, -1174918, -1085872, -437562,
            2040521, 3475996, 35877, 3621178, -1269117, -743638, 442376,
            -278296, -2265303, 1611044, -1440032, 545695, 3186212, 2126009,
            -93566, 1381483, -4000405, -1074727, 291811, 3040864, -1459167,
            -3809294, -1446926, -2959019, 1110797, -2346583, 1125183, -1458376,
            476652, 2246737, -1552594, -321172, -328787, 3727158, 2578512,
            -637322, 2145686, 124009, 316574, 598758, -2180345, -40300,
            1777560, -712912, 3969900, -837615, 4186858, -1992625, 1592425,
            4172055, 1030316, 1732649, 3365500, -2209545, -2216165, 1598405,
            4122715, 4094540, 363060, 369838, -1841354, 3772391, 1383675,
            -1268324, -237400, -3972626, 1314275, -128037, -810499, -3799034,
            -1750396, 766339, 1350337, -519324, -3673999, 873780, -2497778,
            1159808, 3552922, 900408, 3883840, -4073441, 2974189, 763212,
            -1033993, -1137934, -3359093, 452287, 2935586, -917124, 608771,
            3625009, -2851574, -207975, -101949, -3075118, -1522612, -3819111,
            3826184, 2419692, 1871952, -1722545, -710127, 3035522, -3436794,
            -2649023, 383072, 2434951, 3052038,
        ];
        let a_output = [
            775832, -3236070, 3979117, -477690, -3845958, 3442130, 3288278,
            3510572, -4059961, 398894, -2353757, 2033799, 1142104, -1503727,
            -1966738, -646014, -1208934, 2807801, 1786267, 77787, -3034606,
            -2018590, -4138114, -119863, -2143281, -2656209, -1161853,
            -1355718, -3330698, 535482, 3053760, 1831603, 2290608, 2796725,
            -2609926, -663097, 1464007, 2958053, -2816324, 2906926, 500159,
            943996, 524888, -4163949, -834472, 964151, 2161202, 1983774,
            -3656476, -3020535, 952201, 2170010, 711358, 1519731, -3738927,
            -3756753, 921738, -3392868, 2699399, 3324418, -1453193, 1620721,
            449384, -39155, 3109821, 1029974, 142649, 921233, 3727107, 637146,
            -756794, 34504, -1893151, -603841, 2330154, 1322568, -1191265,
            -748922, 1386438, 2435097, 355691, 705695, -504939, 1785625,
            3011361, 2599030, -721431, 3258978, 826952, 3134195, 1786978,
            -2063102, 3719340, -3791185, 766135, 1412965, 2002641, 344357,
            -3493197, -3971320, -1589376, 3333787, -886393, -3473781, 2615969,
            258578, -1357515, 31929, -2417061, 3279057, 623958, 402549,
            -3223514, 1434146, 2674659, 4184013, 2350081, -2255267, 3242948,
            -2755729, 3141850, -3642170, -410070, -3603228, 509187, 747235,
            -2733439, 2951878, 934726, -1464030, -3685617, -177281, -2026915,
            -2014190, 3892744, -2765709, 178393, 1247779, -328544, -647840,
            227976, -1303803, -407239, 2659686, 330785, 22660, 3150838, -49448,
            -3247191, 3366409, 3515827, 2681493, -3955013, 957672, 2270951,
            -2324620, 848541, 252308, 2362816, -480849, 1886753, 1946701,
            -3448907, 3931255, -2029213, -3650910, 3939281, 730275, 2214811,
            1201755, -694587, -2004861, 2583875, 3279717, 3819665, 2574119,
            -2112908, -2400101, -1349537, 3495414, 1347624, -2225620, -2050682,
            -2951590, -3996103, -3607935, 3247458, -2175324, -1553702,
            -2091666, 1571828, -1878102, 2718529, -541427, -662267, -1324341,
            -370258, -474473, 2224715, 2128310, -345001, 1208578, -1376070,
            3433670, 3140605, 875985, -1831696, 449356, -220450, 1787974,
            2388192, -34248, -3456146, 2415580, 1786863, -2849072, -212492,
            59437, -716203, 1968326, 1107129, 434519, 185631, 3036577,
            -2325373, 567821, 1988023, 2839088, -1233636, -3135158, 4161465,
            -3730607, 1882010, -3271303, -2556717, -1387745, -3161242, 1813752,
            -3561981, 130118, -2005282, -3396498, 1716289, -3253036, -1302754,
            2500212, -1918240, 1201565, -1106518, 743553, 902331, 804710,
            -3047027, 3654086, 911638, 3708051,
        ];
        super::intt(&mut a);
        assert_eq!(a, a_output);
    }
}
